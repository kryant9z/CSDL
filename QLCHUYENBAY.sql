CREATE DATABASE QLCHUYENBAY;
USE QLCHUYENBAY;

CREATE TABLE KHACHHANG (
    MAKH NVARCHAR(15),
    TEN NVARCHAR(15),
    DCHI NVARCHAR(50),
    DTHOAI NVARCHAR(12),
    PRIMARY KEY (MAKH)
);

CREATE TABLE NHANVIEN (
    MANV NVARCHAR(15),
    TEN NVARCHAR(15),
    DCHI NVARCHAR(50),
    LUONG NUMERIC(10, 2),
    LOAINV BIT,
    DTHOAI NVARCHAR(12),
    PRIMARY KEY (MANV)
);

CREATE TABLE CHUYENBAY (
    MACB NVARCHAR(4),
    SBDI NVARCHAR(3),
    SBDEN NVARCHAR(3),
    GIODI TIME,
    GIODEN TIME,
    PRIMARY KEY (MACB)
);

CREATE TABLE LOAIMB (
    MALOAI NVARCHAR(15),
    HANGSX NVARCHAR(15),
    PRIMARY KEY (MALOAI)
);

CREATE TABLE MAYBAY (
    SOHIEU INT,
    MALOAI NVARCHAR(15),
    PRIMARY KEY (SOHIEU, MALOAI),
    CONSTRAINT FK_ML FOREIGN KEY (MALOAI) REFERENCES LOAIMB(MALOAI)
);

CREATE TABLE LICHBAY (
    NGAYDI DATETIME,
    MACB NVARCHAR(4),
    SOHIEU INT,
    MALOAI NVARCHAR(15),
    PRIMARY KEY (NGAYDI, MACB),
    CONSTRAINT FK_LICHBAY FOREIGN KEY (MACB) REFERENCES CHUYENBAY(MACB)
);

CREATE TABLE DATCHO (
    MAKH NVARCHAR(15),
    NGAYDI DATETIME,
    MACB NVARCHAR(4),
    PRIMARY KEY (MAKH, NGAYDI, MACB),
    CONSTRAINT FK_MKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
    CONSTRAINT FK_ND FOREIGN KEY (NGAYDI, MACB) REFERENCES LICHBAY(NGAYDI, MACB),
    CONSTRAINT FK_MCB FOREIGN KEY (MACB) REFERENCES CHUYENBAY(MACB)
);

CREATE TABLE KHANANG (
    MANV NVARCHAR(15),
    MALOAI NVARCHAR(15),
    PRIMARY KEY (MANV, MALOAI),
    CONSTRAINT FK_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
    CONSTRAINT FK_MLOAI FOREIGN KEY (MALOAI) REFERENCES LOAIMB(MALOAI)
);

CREATE TABLE PHANCONG (
    MANV NVARCHAR(15),
    NGAYDI DATETIME,
    MACB NVARCHAR(4),
    PRIMARY KEY (MANV, NGAYDI, MACB),
    CONSTRAINT FK_MNV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
    CONSTRAINT FK_NDI2 FOREIGN KEY (NGAYDI, MACB) REFERENCES LICHBAY(NGAYDI, MACB),
    CONSTRAINT FK_MACB2 FOREIGN KEY (MACB) REFERENCES CHUYENBAY(MACB)
);
-- Nhập dữ liệu cho bảng KHACHHANG
INSERT INTO KHACHHANG (MAKH, TEN, DCHI, DTHOAI) VALUES
    ('KH01', N'Nguyễn Văn A', N'Hà Nội', '0123456789'),
    ('KH02', N'Trần Thị B', N'TP.HCM', '0987654321'),
    ('KH03', N'Lê Văn C', N'Đà Nẵng', '0123498765'),
    ('KH04',N'Phạm Thị D', N'Hải Phòng', '0987123456'),
    ('KH05', N'Hoàng Văn E', N'Nha Trang', '0167890123');

-- Nhập dữ liệu cho bảng NHANVIEN
INSERT INTO NHANVIEN (MANV, TEN, DCHI, DTHOAI, LUONG, LOAINV) VALUES
    ('NV01', N'Nguyễn Văn X', N'Hà Nội', '0123456789', 10000000, 1),
    ('NV02', N'Trần Thị Y', N'TP.HCM', '0987654321', 8000000, 0),
    ('NV03', N'Lê Văn Z', N'Đà Nẵng', '0123498765', 9000000, 1),
    ('NV04', N'Phạm Thị T', N'Hải Phòng', '0987123456', 7000000, 0),
    ('NV05', N'Hoàng Văn U', N'Nha Trang', '0167890123', 8500000, 1);

-- Nhập dữ liệu cho bảng LOAIMB
INSERT INTO LOAIMB (MALOAI, HANGSX) VALUES
    ('MB01', 'B747'),
    ('MB02', 'Hãng B'),
    ('MB03', 'Hãng C'),
    ('MB04', 'Hãng D'),
    ('MB05', 'Hãng E');

-- Nhập dữ liệu cho bảng MAYBAY
INSERT INTO MAYBAY (SOHIEU, MALOAI) VALUES
    (1, 'MB01'),
    (2, 'MB02'),
    (3, 'MB03'),
    (4, 'MB04'),
    (5, 'MB05');

-- Nhập dữ liệu cho bảng CHUYENBAY
INSERT INTO CHUYENBAY (MACB, SBDI, SBDEN, GIODI, GIODEN) VALUES
    ('CB01', 'DCA', '100', '14:30', '16:00'),
    ('CB02', 'DCA', 'DEF', '15:00', '17:30'),
    ('CB03', 'DCA', 'GHI', '16:30', '18:30'),
    ('CB04', 'DCA', 'JKL', '17:00', '19:00'),
    ('CB05', 'DCA', 'MNO', '18:30', '20:30');

-- Nhập dữ liệu cho bảng LICHBAY
INSERT INTO LICHBAY (NGAYDI, MACB, SOHIEU, MALOAI) VALUES
    ('2023-06-01', '100', 1, 'MB01'),
    ('2023-06-02', 'CB02', 2, 'MB02'),
    ('2023-06-03', 'CB03', 3, 'MB03'),
    ('2023-06-04', 'CB04', 4, 'MB04'),
    ('2023-06-05', 'CB05', 5, 'MB05');
    
-- Nhập dữ liệu cho bảng DATCHO
INSERT INTO DATCHO (MAKH, NGAYDI, MACB) VALUES
    ('KH01', '2023-06-01', 'CB01'),
    ('KH02', '2023-06-02', 'CB02'),
    ('KH03', '2023-06-03', 'CB03'),
    ('KH04', '2023-06-04', 'CB04'),
    ('KH05', '2023-06-05', 'CB05');

-- Nhập dữ liệu cho bảng KHANANG
INSERT INTO KHANANG (MANV, MALOAI) VALUES
    ('NV01', 'MB01'),
    ('NV02', 'MB02'),
    ('NV03', 'MB03'),
    ('NV04', 'MB04'),
    ('NV05', 'MB05');

-- Nhập dữ liệu cho bảng PHANCONG
INSERT INTO PHANCONG (MANV, NGAYDI, MACB) VALUES
    ('NV01', '2023-06-01', '100'),
    ('NV02', '2023-06-02', 'CB02'),
    ('NV03', '2023-06-03', 'CB03'),
    ('NV04', '2023-06-04', 'CB04'),
    ('NV05', '2023-06-05', 'CB05');
-- Sửa lại bảng LOAIMB
UPDATE LOAIMB
SET HANGSX = 'B747'
WHERE MALOAI = 'MB02'; -- Thay đổi MALOAI tương ứng với loại máy bay B747

-- Sửa lại bảng KHANANG
UPDATE KHANANG
SET MALOAI = 'MB02'
WHERE MALOAI = 'MB01'; -- Thay đổi MALOAI tương ứng với loại máy bay B747

--Cho biết mã số, tên phi công, địa chỉ, điện thoại của các phi công đã từng lái máy bay loại B747.
--CÂU 1
SELECT NV.MANV, NV.TEN, NV.DCHI, NV.DTHOAI
FROM NHANVIEN NV
JOIN KHANANG KN ON NV.MANV = KN.MANV
JOIN LOAIMB LB ON KN.MALOAI = LB.MALOAI
WHERE LB.HANGSX = 'B747';

--Cho biết mã số và ngày đi của các chuyến bay xuất phát từ sân bay DCA trong khoảng thời gian từ 14 giờ đến 18 giờ

--CÂU 2
SELECT MACB, NGAYDI
FROM LICHBAY
WHERE MACB IN (
    SELECT MACB
    FROM CHUYENBAY
    WHERE SBDI = 'DCA' AND GIODI >= '14:00' AND GIODI <= '18:00'
);
-- Cho biết tên những nhân viên được phân công trên chuyến bay có mã số 100 xuất phát  tại sân bay SLC. Các dòng dữ liệu xuất ra không được phép trùng lắp
--CÂU 3
SELECT DISTINCT NV.TEN
FROM NHANVIEN NV
JOIN PHANCONG PC ON NV.MANV = PC.MANV
JOIN CHUYENBAY CB ON PC.MACB = CB.MACB
WHERE CB.MACB = '100' AND CB.SBDI = 'SLC';

-- CÂU 4
SELECT DISTINCT MB.MALOAI, MB.SOHIEU
FROM MAYBAY MB
JOIN LICHBAY LB ON MB.SOHIEU = LB.SOHIEU AND MB.MALOAI = LB.MALOAI
JOIN CHUYENBAY CB ON LB.MACB = CB.MACB
WHERE CB.SBDI = 'MIA';
--CÂU 5
SELECT CB.MACB, LB.NGAYDI, KH.TEN, KH.DCHI, KH.DTHOAI
FROM CHUYENBAY CB
JOIN LICHBAY LB ON CB.MACB = LB.MACB
JOIN DATCHO DC ON LB.MACB = DC.MACB AND LB.NGAYDI = DC.NGAYDI
JOIN KHACHHANG KH ON DC.MAKH = KH.MAKH
ORDER BY CB.MACB ASC, LB.NGAYDI DESC;
--CÂU 6
SELECT CB.MACB, LB.NGAYDI, NV.MANV, NV.TEN, NV.DCHI, NV.DTHOAI
FROM CHUYENBAY CB
JOIN LICHBAY LB ON CB.MACB = LB.MACB
JOIN PHANCONG PC ON LB.MACB = PC.MACB AND LB.NGAYDI = PC.NGAYDI
JOIN NHANVIEN NV ON PC.MANV = NV.MANV
ORDER BY CB.MACB ASC, LB.NGAYDI DESC;
--CÂU 7
SELECT PC.MACB, LB.NGAYDI, NV.MANV, NV.TEN
FROM PHANCONG PC
JOIN LICHBAY LB ON PC.MACB = LB.MACB AND PC.NGAYDI = LB.NGAYDI
JOIN NHANVIEN NV ON PC.MANV = NV.MANV
JOIN CHUYENBAY CB ON PC.MACB = CB.MACB
WHERE CB.SBDEN = 'ORD'
ORDER BY PC.MACB ASC;
--CÂU 8
SELECT PC.MACB, LB.NGAYDI, NV.MANV, NV.TEN
FROM PHANCONG PC
JOIN LICHBAY LB ON PC.MACB = LB.MACB AND PC.NGAYDI = LB.NGAYDI
JOIN NHANVIEN NV ON PC.MANV = NV.MANV
WHERE NV.MANV = '1001'
ORDER BY PC.MACB ASC;

--CÂU 9
SELECT CB.MACB, CB.SBDI, CB.GIODI, CB.GIODEN, LB.NGAYDI
FROM CHUYENBAY CB
JOIN LICHBAY LB ON CB.MACB = LB.MACB
WHERE CB.SBDEN = 'DEN'
ORDER BY LB.NGAYDI DESC, CB.SBDI ASC;

--CÂU 10
SELECT NV.TEN, LB.HANGSX, LB.MALOAI
FROM NHANVIEN NV
JOIN KHANANG KN ON NV.MANV = KN.MANV
JOIN LOAIMB LB ON KN.MALOAI = LB.MALOAI;
--CÂU 11
SELECT NV.MANV, NV.TEN
FROM NHANVIEN NV
JOIN PHANCONG PC ON NV.MANV = PC.MANV
JOIN LICHBAY LB ON PC.MACB = LB.MACB AND PC.NGAYDI = LB.NGAYDI
WHERE LB.MACB = '100' AND LB.NGAYDI = '2000-01-11';

--CÂU 12
SELECT PC.MACB, PC.MANV, NV.TEN
FROM PHANCONG PC
JOIN LICHBAY LB ON PC.MACB = LB.MACB AND PC.NGAYDI = LB.NGAYDI
JOIN NHANVIEN NV ON PC.MANV = NV.MANV
JOIN CHUYENBAY CB ON PC.MACB = CB.MACB
WHERE LB.NGAYDI = '2000-10-31' AND CB.SBDI = 'MIA' AND CB.GIODI = '20:30';

--CÂU 13
SELECT CB.MACB, MB.SOHIEU, LB.MALOAI, LB.HANGSX
FROM CHUYENBAY CB
JOIN LICHBAY LB ON CB.MACB = LB.MACB
JOIN PHANCONG PC ON CB.MACB = PC.MACB AND LB.NGAYDI = PC.NGAYDI
JOIN NHANVIEN NV ON PC.MANV = NV.MANV
JOIN MAYBAY MB ON LB.SOHIEU = MB.SOHIEU AND LB.MALOAI = MB.MALOAI
WHERE NV.TEN = 'Quang';

--CÂU 14
SELECT NV.TEN
FROM NHANVIEN NV
WHERE NV.MANV NOT IN (SELECT MANV FROM PHANCONG);

--CÂU 15
SELECT KH.TEN
FROM KHACHHANG KH
JOIN DATCHO DC ON KH.MAKH = DC.MAKH
JOIN LICHBAY LB ON DC.NGAYDI = LB.NGAYDI AND DC.MACB = LB.MACB
JOIN MAYBAY MB ON LB.SOHIEU = MB.SOHIEU AND LB.MALOAI = MB.MALOAI
JOIN LOAIMB LM ON MB.MALOAI = LM.MALOAI
WHERE LM.HANGSX = 'Boeing';

--CÂU 16
SELECT CB.MACB
FROM CHUYENBAY CB
JOIN LICHBAY LB ON CB.MACB = LB.MACB
JOIN MAYBAY MB ON LB.SOHIEU = MB.SOHIEU AND LB.MALOAI = MB.MALOAI
WHERE MB.SOHIEU = 10 AND MB.MALOAI = 'B747';

--CÂU 17
SELECT CB.SBDEN, COUNT(*) AS SoLuongChuyenBay
FROM CHUYENBAY CB
GROUP BY CB.SBDEN
ORDER BY CB.SBDEN ASC;

--CÂU 18
SELECT CB.SBDI, COUNT(*) AS SoLuongChuyenBay
FROM CHUYENBAY CB
GROUP BY CB.SBDI
ORDER BY CB.SBDI ASC;

--CÂU 19
SELECT CB.SBDI, LB.NGAYDI, COUNT(*) AS SoLuong
FROM CHUYENBAY CB
JOIN LICHBAY LB ON CB.MACB = LB.MACB
GROUP BY CB.SBDI, LB.NGAYDI
ORDER BY LB.NGAYDI DESC, CB.SBDI ASC;

--CÂU 20
SELECT NV.TEN, LM.HANGSX, LM.MALOAI
FROM NHANVIEN NV
JOIN KHANANG KN ON NV.MANV = KN.MANV
JOIN LOAIMB LM ON KN.MALOAI = LM.MALOAI;

--CÂU 21
SELECT LB.MACB, LB.NGAYDI, COUNT(NV.MANV) AS SoLuongNhanVien
FROM LICHBAY LB
JOIN PHANCONG PC ON LB.MACB = PC.MACB
JOIN NHANVIEN NV ON PC.MANV = NV.MANV
WHERE NV.MANV NOT IN (SELECT MANV FROM KHANANG)
GROUP BY LB.MACB, LB.NGAYDI;

--CÂU 22
SELECT COUNT(*) AS SoLuongChuyenBay
FROM CHUYENBAY
WHERE SBDI = 'MIA' AND NGAYDI = '2000-11-01';

--CÂU 23
SELECT PC.MACB, LB.NGAYDI, COUNT(PC.MANV) AS SoLuongNhanVien
FROM PHANCONG PC
JOIN LICHBAY LB ON PC.MACB = LB.MACB
GROUP BY PC.MACB, LB.NGAYDI
ORDER BY COUNT(PC.MANV) DESC;

--CÂU 24
SELECT DC.MACB, LB.NGAYDI, COUNT(DC.MAKH) AS SoLuongHan
FROM DATCHO DC
JOIN LICHBAY LB ON DC.MACB = LB.MACB
GROUP BY DC.MACB, LB.NGAYDI
ORDER BY COUNT(DC.MAKH) DESC;
--CÂU 25
SELECT PC.MACB, LB.NGAYDI, SUM(NV.LUONG) AS TongLuong
FROM PHANCONG PC
JOIN LICHBAY LB ON PC.MACB = LB.MACB
JOIN NHANVIEN NV ON PC.MANV = NV.MANV
GROUP BY PC.MACB, LB.NGAYDI
ORDER BY SUM(NV.LUONG) ASC;

--CÂU 26
SELECT AVG(NV.LUONG) AS LuongTrungBinh
FROM NHANVIEN NV
WHERE NV.MANV NOT IN (SELECT MANV FROM KHANANG);

--CÂU 27
SELECT AVG(NV.LUONG) AS LuongTrungBinh
FROM NHANVIEN NV
WHERE NV.MANV IN (SELECT MANV FROM KHANANG);


-- CÂU 28
SELECT LM.MALOAI, LM.HANGSX, COUNT(CB.MACB) AS SoLuongChuyenBay
FROM CHUYENBAY CB
JOIN LOAIMB LM ON CB.MALOAI = LM.MALOAI
WHERE CB.SBDEN = 'ORD'
GROUP BY LM.MALOAI, LM.HANGSX;

-- CÂU 29
SELECT CB.SBDI, COUNT(*) AS SoLuongChuyenBay
FROM CHUYENBAY CB
WHERE EXTRACT(HOUR FROM CB.GIODI) BETWEEN 10 AND 22
GROUP BY CB.SBDI
HAVING COUNT(*) > 2;

-- CÂU 30
SELECT NV.TEN
FROM NHANVIEN NV
JOIN PHANCONG PC ON NV.MANV = PC.MANV
JOIN LICHBAY LB ON PC.MACB = LB.MACB
WHERE LB.NGAYDI = '2000-01-11'
GROUP BY NV.TEN
HAVING COUNT(PC.MACB) >= 2;

-- CÂU 31
SELECT DC.MACB, LB.NGAYDI
FROM DATCHO DC
JOIN LICHBAY LB ON DC.MACB = LB.MACB
GROUP BY DC.MACB, LB.NGAYDI
HAVING COUNT(DC.MAKH) < 3;

-- CÂU 32
SELECT MB.SOHIEMB, LM.MALOAI
FROM NHANVIEN NV
JOIN PHANCONG PC ON NV.MANV = PC.MANV
JOIN CHUYENBAY CB ON PC.MACB = CB.MACB
JOIN LOAIMB LM ON CB.MALOAI = LM.MALOAI
JOIN MAYBAY MB ON CB.SOHIEUMB = MB.SOHIEU
WHERE NV.MANV = 1001
GROUP BY MB.SOHIEMB, LM.MALOAI
HAVING COUNT(PC.MACB) >= 2;

-- CÂU 33
SELECT MB.HANGSX, COUNT(DISTINCT MB.MALOAI) AS SoLuongLoaiMayBay
FROM MAYBAY MB
GROUP BY MB.HANGSX;

-- CÂU 34
SELECT MB.HANGSX, LM.MALOAI, MB.SOHIEU
FROM MAYBAY MB
JOIN LOAIMB LM ON MB.MALOAI = LM.MALOAI
GROUP BY MB.HANGSX, LM.MALOAI, MB.SOHIEU
ORDER BY COUNT(*) DESC
LIMIT 1;

-- CÂU 35
SELECT NV.TEN
FROM NHANVIEN NV
JOIN PHANCONG PC ON NV.MANV = PC.MANV
GROUP BY NV.TEN
ORDER BY COUNT(PC.MACB) DESC
LIMIT 1;

-- CÂU 36
SELECT NV.TEN, NV.DIACHI, NV.DIENTHOAI
FROM NHANVIEN NV
JOIN PHANCONG PC ON NV.MANV = PC.MANV
WHERE NV.CHUCVU = 'Phi công'
GROUP BY NV.TEN, NV.DIACHI, NV.DIENTHOAI
ORDER BY COUNT(PC.MACB) DESC
LIMIT 1;

-- CÂU 37
SELECT CB.SBDEN, COUNT(*) AS SoLuongChuyenBay
FROM CHUYENBAY CB
GROUP BY CB.SBDEN
ORDER BY COUNT(*) ASC
LIMIT 1;

-- CÂU 38
SELECT CB.SBDI, COUNT(*) AS SoLuongChuyenBay
FROM CHUYENBAY CB
GROUP BY CB.SBDI
ORDER BY COUNT(*) DESC
LIMIT 1;

-- CÂU 39
SELECT KH.TEN, KH.DIACHI, KH.DIENTHOAI
FROM KHACHHANG KH
JOIN VE V ON KH.MAKH = V.MAKH
GROUP BY KH.TEN, KH.DIACHI, KH.DIENTHOAI
ORDER BY COUNT(*) DESC
LIMIT 1;

-- CÂU 40
SELECT NV.MANV, NV.TEN, NV.LUONG
FROM NHANVIEN NV
JOIN PHANCONG PC ON NV.MANV = PC.MANV
JOIN MAYBAY MB ON PC.SOHIEUMB = MB.SOHIEU
GROUP BY NV.MANV, NV.TEN, NV.LUONG
HAVING COUNT(DISTINCT MB.MALOAI) = (
    SELECT MAX(SoLuongLoaiMayBay)
    FROM (
        SELECT NV.MANV, COUNT(DISTINCT MB.MALOAI) AS SoLuongLoaiMayBay
        FROM NHANVIEN NV
        JOIN PHANCONG PC ON NV.MANV = PC.MANV
        JOIN MAYBAY MB ON PC.SOHIEUMB = MB.SOHIEU
        GROUP BY NV.MANV
    ) AS SubQuery
);

-- CÂU 41
SELECT NV.MANV, NV.TEN, NV.LUONG
FROM NHANVIEN NV
WHERE NV.LUONG = (
    SELECT MAX(LUONG)
    FROM NHANVIEN
);

-- CÂU 42
SELECT NH.TEN, NH.DIACHI
FROM NHANVIEN NH
JOIN PHANCONG PC ON NH.MANV = PC.MANV
WHERE PC.MACB = <MaChuyenBay>
GROUP BY NH.TEN, NH.DIACHI
HAVING NH.LUONG = (
    SELECT MAX(LUONG)
    FROM NHANVIEN
    WHERE MANV IN (
        SELECT MANV
        FROM PHANCONG
        WHERE MACB = <MaChuyenBay>
    )
);

-- CÂU 43
SELECT CB.MACB, CB.GIODI, CB.GIODEN
FROM CHUYENBAY CB
WHERE CB.GIODI = (
    SELECT MIN(GIODI)
    FROM CHUYENBAY
    WHERE NGAYDI = '<NgayDi>'
);

-- CÂU 44
SELECT CB.MACB, TIMEDIFF(CB.GIODEN, CB.GIODI) AS ThoiGianBay
FROM CHUYENBAY CB
ORDER BY TIMEDIFF(CB.GIODEN, CB.GIODI) DESC
LIMIT 1;

-- CÂU 45
SELECT CB.MACB, TIMEDIFF(CB.GIODEN, CB.GIODI) AS ThoiGianBay
FROM CHUYENBAY CB
ORDER BY TIMEDIFF(CB.GIODEN, CB.GIODI) ASC
LIMIT 1;

-- CÂU 46
SELECT CB.MACB, CB.NGAYDI
FROM CHUYENBAY CB
JOIN MAYBAY MB ON CB.SOHIEUMB = MB.SOHIEU
JOIN LOAIMB LM ON MB.MALOAI = LM.MALOAI
WHERE LM.TENLOAI = 'B747'
GROUP BY CB.MACB, CB.NGAYDI
HAVING COUNT(*) = (
    SELECT MAX(SoLuongChuyenBay)
    FROM (
        SELECT CB.MACB, COUNT(*) AS SoLuongChuyenBay
        FROM CHUYENBAY CB
        JOIN MAYBAY MB ON CB.SOHIEUMB = MB.SOHIEU
        JOIN LOAIMB LM ON MB.MALOAI = LM.MALOAI
        WHERE LM.TENLOAI = 'B747'
        GROUP BY CB.MACB, CB.NGAYDI
    ) AS SubQuery
);

-- CÂU 47
SELECT CB.MACB, COUNT(*) AS SoLuongNhanVien
FROM CHUYENBAY CB
JOIN PHANCONG PC ON CB.MACB = PC.MACB
WHERE (
    SELECT COUNT(*)
    FROM DATVE DV
    WHERE DV.MACB = CB.MACB
) > 3
GROUP BY CB.MACB;

-- CÂU 48
SELECT LV.TENLOAI, COUNT(*) AS SoLuongNhanVien
FROM LOAINV LV
JOIN NHANVIEN NV ON LV.MALOAI = NV.MALOAI
GROUP BY LV.TENLOAI
HAVING SUM(NV.LUONG) > 600000;


-- CÂU 49
SELECT CB.MACB, COUNT(*) AS SoLuongKhachHang
FROM CHUYENBAY CB
JOIN DATVE DV ON CB.MACB = DV.MACB
WHERE (
    SELECT COUNT(*)
    FROM PHANCONG PC
    WHERE PC.MACB = CB.MACB
) > 3
GROUP BY CB.MACB;

-- CÂU 50
SELECT MB.MALOAI, COUNT(*) AS SoLuongChuyenBay
FROM MAYBAY MB
GROUP BY MB.MALOAI
HAVING COUNT(*) > 1;

-- CÂU 51
SELECT CB.MACB
FROM CHUYENBAY CB
WHERE NOT EXISTS (
    SELECT MB.SOHIEU
    FROM MAYBAY MB
    WHERE MB.HANGSX = 'Boeing'
    AND NOT EXISTS (
        SELECT *
        FROM LICHCHUYENBAY LCB
        WHERE LCB.MACB = CB.MACB
        AND LCB.SOHIEU = MB.SOHIEU
    )
);

-- CÂU 52
SELECT NV.MANV, NV.TENNV
FROM NHANVIEN NV
WHERE NV.MANV IN (
    SELECT PC.MANV
    FROM PHUCAP PC
    WHERE PC.MALOAI IN (
        SELECT ML.MALOAI
        FROM MALOAI ML
        WHERE ML.HANGSX = 'Airbus'
        GROUP BY ML.MALOAI
        HAVING COUNT(DISTINCT ML.SOHIEU) = (
            SELECT COUNT(DISTINCT SOHIEU)
            FROM MAYBAY
            WHERE HANGSX = 'Airbus'
        )
    )
);

-- CÂU 53
SELECT DISTINCT NV.TENNV
FROM NHANVIEN NV
WHERE NV.MANV NOT IN (
    SELECT PC.MANV
    FROM PHUCAP PC, LICHCHUYENBAY LCB
    WHERE PC.MANV = LCB.MANV
    AND LCB.MACB = '100'
    AND PC.MALOAI = 'PhiCong'
);

-- CÂU 54
SELECT LCB.NGAYDI
FROM LICHCHUYENBAY LCB
GROUP BY LCB.NGAYDI
HAVING COUNT(DISTINCT LCB.SOHIEU) = (
    SELECT COUNT(DISTINCT SOHIEU)
    FROM MAYBAY
    WHERE HANGSX = 'Boeing'
);

-- CÂU 55
SELECT MB.LOAI
FROM MAYBAY MB
WHERE MB.HANGSX = 'Boeing'
AND NOT EXISTS (
    SELECT *
    FROM LICHCHUYENBAY LCB
    WHERE LCB.SOHIEU = MB.SOHIEU
    GROUP BY LCB.NGAYDI
    HAVING COUNT(*) = (
        SELECT COUNT(DISTINCT NGAYDI)
        FROM LICHCHUYENBAY
    )
);

-- CÂU 56
SELECT KH.MAKH, KH.TENKH
FROM KHACHHANG KH
WHERE NOT EXISTS (
    SELECT *
    FROM LICHCHUYENBAY LCB
    WHERE LCB.MAKH = KH.MAKH
    AND LCB.NGAYDI BETWEEN '2000-10-31' AND '2001-01-01'
    GROUP BY LCB.NGAYDI
    HAVING COUNT(*) <> 1
);



